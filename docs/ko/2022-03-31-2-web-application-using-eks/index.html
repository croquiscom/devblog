<!DOCTYPE html>
<html lang='ko'>

<head>
  <meta charset='utf-8'>

  <title>EKS를 사용해서 어플리케이션 서비스 하기</title>
  
  <meta name='author' content='kakaostyle.com'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>

  <meta property='og:title' content='EKS를 사용해서 어플리케이션 서비스 하기' />
  <meta property='og:type' content='article' />
  <meta property='og:url' content='https://devblog.croquis.com/ko/2022-03-31-2-web-application-using-eks/' />
  

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
    integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
  <link href='/css/style.css?body=1' rel='stylesheet' type='text/css' media='all'>
  <link href='/css/syntax.css?body=1' rel='stylesheet' type='text/css' media='all'>
</head>

<body>
<div class='hp-navbar-top'>
  <div class='container'>
    <div class='row'>
      <div class='col-12'>
        <nav class='hp-nav'>
          <span>
            <a href='/' class='logo-a-tag'>
              <img class='hp-navbar-logo' src='/img/logo-kakaostyle.png'>
              <span class='hp-navbar-logo-font'>기술 블로그</span>
            </a>
          </span>
        </nav>
        <div class='float-right hp-navbar-top-link'>
          <a class='hp-nav-item' href='https://kakaostyle.com' target='_blank'>
            <img class='icon' src='/img/kakaostyle-icon.png'>
          </a>
          <a class='hp-nav-item' href='https://github.com/croquiscom' target='_blank'>
            <img class='icon' src='/img/github-icon.svg'>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<div class='hp-navbar'>
  <div class='hp-navbar-bgcolor'>
    <div class='container'>
      <div class='text-center'>
        <div class='hp-navbar-title'>EKS를 사용해서 어플리케이션 서비스 하기</div>
      </div>
    </div>
  </div>
</div>


<div class='container'>

  <div class='row'>
    <div class='col-12'>
      <div class='post-header'>
        <div class='post-tags'>
          

<ul class='tag_box inline'>
  <li><i class='fas fa-tags'></i></li>
  
  <li>
    <a href='/ko/tags/aws'>
      AWS
      <span>6</span>
    </a>
  </li>
  
  <li>
    <a href='/ko/tags/kubernetes'>
      Kubernetes
      <span>2</span>
    </a>
  </li>
  
  <li>
    <a href='/ko/tags/tutorial'>
      Tutorial
      <span>3</span>
    </a>
  </li>
  
</ul>

        </div>
        <div class='float-right'>
          
          <div class='post-author'>
            <i class='fas fa-pencil-alt'></i>
            <span>Simon(윤상민)</span>
          </div>
          
          <div class='post-date'>
            <i class='fas fa-calendar-alt'></i>
            <span>31 March 2022</span>
          </div>
        </div>
      </div>
    </div>

    <div class='col-12 col-lg-9'>
      <p><a href="/ko/2022-03-31-1-web-application-using-ecs/">ECS 아티클</a>에 이어 이번 글에서는 같은 서비스를 EKS로 구축해보도록 하겠습니다.</p>
<p>간단하게 구축하는 것은 <a href="https://eksctl.io/">eksctl</a>을 쓰면 되지만, 내부 이해를 위해 여기서는 기본부터 구현하도록 하겠습니다.</p>
<h2 id="vpc-셋업">VPC 셋업</h2>
<p>VPC는 이전과 마찬가지로 두 개의 AZ에 퍼블릭 서브넷과 프리이빗 서브넷이 필요합니다. 다만 로드 밸런서가 정상적으로 배치되려며 특정한 태그를 서브넷에 부여해야합니다.</p>
<p><img src="/img/content/2022-03-31-2/2022-03-31-2-01.png" alt="Sample VPC"></p>
<p>서비스 컨테이너만 정의하는 ECS와 달리 쿠버네티스는 클러스터 내에서 로드 밸런서, 영구 볼륨등도 정의할 수 있습니다. 이때 정의는 쿠버네티스안에서 하지만 실제 만들어지는 것은 쿠버네티스와 무관한 AWS 리소스(ALB, EBS등)입니다. 쿠버네티스 자체는 AWS 구조와 독립적이고, 태그등 다른 방법을 통해 쿠버네티스 리소스가 위치할 AWS 리소스를 찾게 됩니다.</p>
<p><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html">EKS에서 애플리케이션 로드 밸런싱 문서</a>에 따라 다음 태그를 설정해줍니다.</p>
<ul>
<li><code>kubernetes.io/cluster/&lt;name&gt;</code>: <code>shared</code></li>
<li><code>kubernetes.io/role/internal-elb</code>: 프라이빗 서브넷에 대해 <code>1</code>로 설정합니다.</li>
<li><code>kubernetes.io/role/elb</code>: 퍼블릭 서브넷에 대해 <code>1</code>로 설정합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">provider</span> <span class="s2">&#34;aws&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  region</span> <span class="o">=</span> <span class="s2">&#34;ap-northeast-2&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_name</span>        <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr</span>            <span class="o">=</span> <span class="s2">&#34;10.194.0.0/16&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  public_subnets</span>  <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.0.0/24&#34;, &#34;10.194.1.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  private_subnets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;10.194.100.0/24&#34;, &#34;10.194.101.0/24&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  azs</span>             <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;ap-northeast-2a&#34;, &#34;ap-northeast-2c&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  cluster_name</span>    <span class="o">=</span> <span class="s2">&#34;simon-test&#34;</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPC를 생성합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_vpc&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cidr</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>       <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">vpc_name</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPC 생성시 기본으로 생성되는 라우트 테이블에 이름을 붙입니다
</span></span></span><span class="line"><span class="cl"><span class="c1">## 이걸 서브넷에 연결해 써도 되지만, 여기서는 사용하지 않습니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_default_route_table&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  default_route_table_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">default_route_table_id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>                   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-default&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## VPC 생성시 기본으로 생성되는 보안 그룹에 이름을 붙입니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_default_security_group&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-default&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷에 연결할 인터넷 게이트웨이를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_internet_gateway&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-igw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷에 적용할 라우팅 테이블
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-public&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷에서 인터넷에 트래픽 요청시 앞서 정의한 인터넷 게이트웨이로 보냅니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route&#34; &#34;public_worldwide&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span>         <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">public</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  destination_cidr_block</span> <span class="o">=</span> <span class="s2">&#34;0.0.0.0/0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  gateway_id</span>             <span class="o">=</span> <span class="k">aws_internet_gateway</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷을 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_subnet&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">)</span><span class="c1"> # 여러개를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>                  <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span>              <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  availability_zone</span>       <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">azs</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  map_public_ip_on_launch</span> <span class="o">=</span> <span class="kt">true</span><span class="c1"> # 퍼플릭 서브넷에 배치되는 서비스는 자동으로 공개 IP를 부여합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  tags</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-public-${count.index + 1}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/cluster/${local.cluster_name}&#34;</span> <span class="o">=</span> <span class="s2">&#34;shared&#34;</span><span class="p">,</span><span class="c1"> # 다른 부분
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">    &#34;kubernetes.io/role/elb&#34;</span>                      <span class="o">=</span> <span class="s2">&#34;1&#34;</span><span class="c1"> # 다른 부분
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 퍼플릭 서브넷을 라우팅 테이블에 연결합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table_association&#34; &#34;public&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">public_subnets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>      <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">public</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span> <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">public</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## NAT 게이트웨이는 고정 IP를 필요로 합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_eip&#34; &#34;nat_gateway&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc</span>  <span class="o">=</span> <span class="kt">true</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-natgw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷에서 인터넷 접속시 사용할 NAT 게이트웨이
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_nat_gateway&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  allocation_id</span> <span class="o">=</span> <span class="k">aws_eip</span><span class="p">.</span><span class="k">nat_gateway</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>     <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">public</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="k">id</span><span class="c1"> # NAT 게이트웨이 자체는 퍼플릭 서브넷에 위치해야 합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">  tags</span>          <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-natgw&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷에 적용할 라우팅 테이블
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span>   <span class="o">=</span><span class="n"> { Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-private&#34;</span> }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷에서 인터넷에 트래픽 요청시 앞서 정의한 NAT 게이트웨이로 보냅니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route&#34; &#34;private_worldwide&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span>         <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">private</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  destination_cidr_block</span> <span class="o">=</span> <span class="s2">&#34;0.0.0.0/0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  nat_gateway_id</span>         <span class="o">=</span> <span class="k">aws_nat_gateway</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷을 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_subnet&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">)</span><span class="c1"> # 여러개를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">  vpc_id</span>            <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  cidr_block</span>        <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  availability_zone</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">azs</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">  tags</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;${local.vpc_name}-private-${count.index + 1}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    &#34;kubernetes.io/cluster/${local.cluster_name}&#34;</span> <span class="o">=</span> <span class="s2">&#34;shared&#34;</span><span class="p">,</span><span class="c1"> # 다른 부분
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">    &#34;kubernetes.io/role/internal-elb&#34;</span>             <span class="o">=</span> <span class="s2">&#34;1&#34;</span><span class="c1"> # 다른 부분
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  }
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## 프라이빗 서브넷을 라우팅 테이블에 연결합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_route_table_association&#34; &#34;private&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">private_subnets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  subnet_id</span>      <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl"><span class="n">  route_table_id</span> <span class="o">=</span> <span class="k">aws_route_table</span><span class="p">.</span><span class="k">private</span><span class="p">.</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h2 id="eks-클러스터-생성">EKS 클러스터 생성</h2>
<p>ECS가 하나의 리소스로 끝난 것에 비해 EKS는 조금 복잡합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1">## 클러스터가 사용할 역할을 정의합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1">## AmazonEKSClusterPolicy와 AmazonEKSVPCResourceController를 포함합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_iam_role&#34; &#34;cluster&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;${local.cluster_name}-eks-cluster-role&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  assume_role_policy</span> <span class="o">=</span> <span class="k">jsonencode</span><span class="p">(</span>{
</span></span><span class="line"><span class="cl"><span class="n">    Version</span> <span class="o">=</span> <span class="s2">&#34;2012-10-17&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    Statement</span> <span class="o">=</span> <span class="p">[</span>{
</span></span><span class="line"><span class="cl"><span class="n">      Effect</span> <span class="o">=</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Principal</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">        Service</span> <span class="o">=</span> <span class="s2">&#34;eks.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">      }<span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Action</span> <span class="o">=</span> <span class="s2">&#34;sts:AssumeRole&#34;</span>
</span></span><span class="line"><span class="cl">    }<span class="p">]</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy_attachment&#34; &#34;cluster_AmazonEKSClusterPolicy&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  policy_arn</span> <span class="o">=</span> <span class="s2">&#34;arn:aws:iam::aws:policy/AmazonEKSClusterPolicy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>       <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy_attachment&#34; &#34;cluster_AmazonEKSVPCResourceController&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  policy_arn</span> <span class="o">=</span> <span class="s2">&#34;arn:aws:iam::aws:policy/AmazonEKSVPCResourceController&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>       <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## EKS 클러스터를 정의합니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_eks_cluster&#34; &#34;this&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span>     <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">cluster_name</span>
</span></span><span class="line"><span class="cl"><span class="n">  role_arn</span> <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">cluster</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl">  <span class="k">vpc_config</span> {
</span></span><span class="line"><span class="cl"><span class="n">    subnet_ids</span> <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="k">id</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl"><span class="n">  depends_on</span> <span class="o">=</span> <span class="p">[</span><span class="c1"> # see https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/eks_cluster#example-usage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">aws_iam_role_policy_attachment</span><span class="p">.</span><span class="k">cluster_AmazonEKSClusterPolicy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">aws_iam_role_policy_attachment</span><span class="p">.</span><span class="k">cluster_AmazonEKSVPCResourceController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## Fargate에서 팟 배치시 사용하는 실행 역할을 정의합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1">## AmazonEKSFargatePodExecutionRolePolicy를 포함합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_iam_role&#34; &#34;pod_execution&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;${local.cluster_name}-eks-pod-execution-role&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">  assume_role_policy</span> <span class="o">=</span> <span class="k">jsonencode</span><span class="p">(</span>{
</span></span><span class="line"><span class="cl"><span class="n">    Version</span> <span class="o">=</span> <span class="s2">&#34;2012-10-17&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">    Statement</span> <span class="o">=</span> <span class="p">[</span>{
</span></span><span class="line"><span class="cl"><span class="n">      Effect</span> <span class="o">=</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Principal</span> <span class="o">=</span> {
</span></span><span class="line"><span class="cl"><span class="n">        Service</span> <span class="o">=</span> <span class="s2">&#34;eks-fargate-pods.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">      }<span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">      Action</span> <span class="o">=</span> <span class="s2">&#34;sts:AssumeRole&#34;</span>
</span></span><span class="line"><span class="cl">    }<span class="p">]</span>
</span></span><span class="line"><span class="cl">  }<span class="p">)</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_role_policy_attachment&#34; &#34;pod_execution_AmazonEKSFargatePodExecutionRolePolicy&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  policy_arn</span> <span class="o">=</span> <span class="s2">&#34;arn:aws:iam::aws:policy/AmazonEKSFargatePodExecutionRolePolicy&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  role</span>       <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">pod_execution</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## EKS 클러스터에 노드를 Fargate로 공급합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1">## default/kube-system 네임스페이스를 가진 팟에 대해 적용됩니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_eks_fargate_profile&#34; &#34;default&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  cluster_name</span>           <span class="o">=</span> <span class="k">aws_eks_cluster</span><span class="p">.</span><span class="k">this</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="cl"><span class="n">  fargate_profile_name</span>   <span class="o">=</span> <span class="s2">&#34;fp-default&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  pod_execution_role_arn</span> <span class="o">=</span> <span class="k">aws_iam_role</span><span class="p">.</span><span class="k">pod_execution</span><span class="p">.</span><span class="k">arn</span>
</span></span><span class="line"><span class="cl"><span class="n">  subnet_ids</span>             <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">private</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="k">id</span><span class="c1"> # 프라이빗 서브넷만 줄 수 있습니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">selector</span> {
</span></span><span class="line"><span class="cl"><span class="n">    namespace</span> <span class="o">=</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  <span class="k">selector</span> {
</span></span><span class="line"><span class="cl"><span class="n">    namespace</span> <span class="o">=</span> <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>쿠버네티스 클러스터에 접근할 수 있도록 <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-kubeconfig.html">kubeconfig를 생성</a>합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ aws eks update-kubeconfig --region ap-northeast-2 --name simon-test --alias simon-test
</span></span></code></pre></div><p>이제 쿠버네티스 클러스터의 상태를 볼 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get svc
</span></span><span class="line"><span class="cl">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
</span></span><span class="line"><span class="cl">kubernetes   ClusterIP   172.20.0.1   &lt;none&gt;        443/TCP   23m
</span></span></code></pre></div><p>그런데 팟 목록을 보면 기본적으로 실행되어야 할 coredns 팟이 뜨지 않는 것이 보입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get pods -n kube-system
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">coredns-6dbb778559-clx8r   0/1     Pending   <span class="m">0</span>          13m
</span></span><span class="line"><span class="cl">coredns-6dbb778559-zpx2h   0/1     Pending   <span class="m">0</span>          13m
</span></span></code></pre></div><p>Fargate 노드만 사용하려면 <a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-getting-started.html#fargate-gs-coredns">CoreDNS 내용을 수정 해줘야</a> 합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl patch deployment coredns <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -n kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --type json <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -p<span class="o">=</span><span class="s1">&#39;[{&#34;op&#34;: &#34;remove&#34;, &#34;path&#34;: &#34;/spec/template/metadata/annotations/eks.amazonaws.com~1compute-type&#34;}]&#39;</span>
</span></span><span class="line"><span class="cl">deployment.apps/coredns patched
</span></span><span class="line"><span class="cl">$ kubectl get pods -n kube-system                          
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">coredns-6f99dbb876-hp667   1/1     Running   <span class="m">0</span>          4m
</span></span><span class="line"><span class="cl">coredns-6f99dbb876-skrgn   1/1     Running   <span class="m">0</span>          4m
</span></span></code></pre></div><p>컨테이너에 IAM 권한을 부여하려면 <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/enable-iam-roles-for-service-accounts.html">OIDC 공급자 생성</a>이 필요합니다</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ eksctl utils associate-iam-oidc-provider --cluster simon-test --approve
</span></span></code></pre></div><h2 id="서비스-구동">서비스 구동</h2>
<p>이제 우리가 만든 어플리케이션을 EKS 클러스터에 올릴 차례입니다.</p>
<p>이전과 마찬가지로 ECR 저장소를 만들고 이미지를 올려둡니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">locals</span> {
</span></span><span class="line"><span class="cl"><span class="n">  app_name</span> <span class="o">=</span> <span class="s2">&#34;simon-sample&#34;</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">## simon-sample 앱을 위한 저장소를 만듭니다
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;aws_ecr_repository&#34; &#34;simon_sample&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  name</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">app_name</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>이 이미지를 띄우는 것은 쿠버네티스가 처리합니다.</p>
<p>쿠버네티스에 띄우는 가장 작은 단위는 <a href="https://kubernetes.io/ko/docs/concepts/workloads/pods/">파드</a>입니다. 다만 파드로 띄우면 서버를 확장하는 것이 어렵습니다. <a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/replicaset/">레플리카셋</a>이라는 리소스를 사용하면 파드를 여러개 띄울 수 있습니다. 여기에 더해 <a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/">디플로이먼트</a>를 리소스를 사용하면 어플리케이션 갱신시 레플리카셋 교체를 해줍니다.</p>
<p>다음과 같이 쿠버네티스 리소스를 정의합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;aws-account-id&gt;.dkr.ecr.ap-northeast-2.amazonaws.com/simon-sample:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span></code></pre></div><p>다음 명령으로 적용합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl apply -f simon-sample.yaml
</span></span><span class="line"><span class="cl">deployment.apps/simon-sample created
</span></span></code></pre></div><p>보통 5분 안에(빠르면 1분 안에) 다음과 같이 Running 상태로 바뀝니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get pods -o wide                 
</span></span><span class="line"><span class="cl">NAME                           READY   STATUS    RESTARTS   AGE     IP              NODE                    NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">simon-sample-dd88b97bc-svtd6   1/1     Running   <span class="m">0</span>          3m45s   10.194.101.15   fargate-10.194.101.15   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>포트 포워딩으로 세팅하고, HTTP 요청을 하면 응답이 오는 것을 볼 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl port-forward simon-sample-dd88b97bc-svtd6 3000:3000
</span></span><span class="line"><span class="cl">Forwarding from 127.0.0.1:3000 -&gt; <span class="m">3000</span>
</span></span><span class="line"><span class="cl">Handling connection <span class="k">for</span> <span class="m">3000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## from other terminal</span>
</span></span><span class="line"><span class="cl">$ curl localhost:3000 --data <span class="s1">&#39;hello world&#39;</span>
</span></span><span class="line"><span class="cl">hello world
</span></span></code></pre></div><h2 id="서비스를-외부에-노출하기">서비스를 외부에 노출하기</h2>
<p>ECS와 마찬가지로 실제 서비스가 되려면 외부에 노출된 로드 밸런서에 우리의 서비스를 붙여줘야 합니다. ECS와 달리 쿠버네티스에서는 로드 밸런서 정의도 쿠버네티스 리소스로 정의합니다. 하지만 실제로는 EKS가 알아서 AWS 로드 밸런서를 생성하게 됩니다.</p>
<p>어플리케이션 계층(L7)에서 동작하는 Application Load Balancer(ALB)를 생성하기 위한 리소스 타입은 <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a> 입니다.</p>
<p>우선 <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/aws-load-balancer-controller.html">AWS Load Balancer Controller 추가 기능 설치</a>가 필요합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## ALB를 컨트롤 할 수 있는 정책을 생성합니다.</span>
</span></span><span class="line"><span class="cl">$ curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.0/docs/install/iam_policy.json
</span></span><span class="line"><span class="cl">$ aws iam create-policy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --policy-name AWSLoadBalancerControllerIAMPolicy-simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --policy-document file://iam_policy.json
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 위 정책을 포함한 IAM 역할을 생성합니다.</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">ACCOUNT_ID</span><span class="o">=</span><span class="k">$(</span>aws sts get-caller-identity <span class="p">|</span> jq -r .Account<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">OIDC_URL</span><span class="o">=</span><span class="k">$(</span>aws eks describe-cluster --name simon-test --query <span class="s2">&#34;cluster.identity.oidc.issuer&#34;</span> --output text <span class="p">|</span> sed <span class="s2">&#34;s|https://||&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">$ cat &gt; load-balancer-role-trust-policy.json <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">{
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;Statement&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="s">        {
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Principal&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">                &#34;Federated&#34;: &#34;arn:aws:iam::${ACCOUNT_ID}:oidc-provider/$OIDC_URL&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">            },
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Action&#34;: &#34;sts:AssumeRoleWithWebIdentity&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;Condition&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">                &#34;StringEquals&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">                    &#34;${OIDC_URL}:aud&#34;: &#34;sts.amazonaws.com&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">                    &#34;${OIDC_URL}:sub&#34;: &#34;system:serviceaccount:kube-system:aws-load-balancer-controller&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">                }
</span></span></span><span class="line"><span class="cl"><span class="s">            }
</span></span></span><span class="line"><span class="cl"><span class="s">        }
</span></span></span><span class="line"><span class="cl"><span class="s">    ]
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">$ aws iam create-role <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --role-name AmazonEKSLoadBalancerControllerRole-simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --assume-role-policy-document file://<span class="s2">&#34;load-balancer-role-trust-policy.json&#34;</span>
</span></span><span class="line"><span class="cl">$ aws iam attach-role-policy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --policy-arn arn:aws:iam::<span class="si">${</span><span class="nv">ACCOUNT_ID</span><span class="si">}</span>:policy/AWSLoadBalancerControllerIAMPolicy-simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --role-name AmazonEKSLoadBalancerControllerRole-simon-test
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## IAM 역할에 연결된 쿠베네티스 서비스 계정을 생성합니다.</span>
</span></span><span class="line"><span class="cl">$ cat &gt; aws-load-balancer-controller-service-account.yaml <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ServiceAccount
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app.kubernetes.io/component: controller
</span></span></span><span class="line"><span class="cl"><span class="s">    app.kubernetes.io/name: aws-load-balancer-controller
</span></span></span><span class="line"><span class="cl"><span class="s">  name: aws-load-balancer-controller
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: kube-system
</span></span></span><span class="line"><span class="cl"><span class="s">  annotations:
</span></span></span><span class="line"><span class="cl"><span class="s">    eks.amazonaws.com/role-arn: arn:aws:iam::${ACCOUNT_ID}:role/AmazonEKSLoadBalancerControllerRole-simon-test
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">$ kubectl apply -f aws-load-balancer-controller-service-account.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## AWS Load Balancer Controller를 설치합니다</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">VPC_ID</span><span class="o">=</span><span class="k">$(</span>aws ec2 describe-vpcs --filters <span class="nv">Name</span><span class="o">=</span>cidr,Values<span class="o">=</span>10.194.0.0/16 <span class="p">|</span> jq -r .Vpcs<span class="o">[</span>0<span class="o">]</span>.VpcId<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ helm repo add eks https://aws.github.io/eks-charts
</span></span><span class="line"><span class="cl">$ helm repo update
</span></span><span class="line"><span class="cl">$ helm install aws-load-balancer-controller eks/aws-load-balancer-controller <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -n kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">clusterName</span><span class="o">=</span>simon-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set serviceAccount.create<span class="o">=</span><span class="nb">false</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set serviceAccount.name<span class="o">=</span>aws-load-balancer-controller <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">region</span><span class="o">=</span>ap-northeast-2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">vpcId</span><span class="o">=</span><span class="nv">$VPC_ID</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set image.repository<span class="o">=</span>602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon/aws-load-balancer-controller
</span></span><span class="line"><span class="cl">NAME: aws-load-balancer-controller
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Sat Mar <span class="m">26</span> 10:02:19 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">NAMESPACE: kube-system
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">AWS Load Balancer controller installed!
</span></span><span class="line"><span class="cl">$ kubectl get deployment -n kube-system aws-load-balancer-controller
</span></span><span class="line"><span class="cl">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">aws-load-balancer-controller   2/2     <span class="m">2</span>            <span class="m">2</span>           5m51s
</span></span></code></pre></div><p>이제 쿠버네티스를 통해 ALB를 생성하고, 아까 만든 앱을 등록합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-test-alb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/scheme</span><span class="p">:</span><span class="w"> </span><span class="l">internet-facing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/target-type</span><span class="p">:</span><span class="w"> </span><span class="l">ip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">alb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simon-sample-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span></code></pre></div><p>이제 로드 밸런서 주소로 요청을 보내면 응답을 보내옵니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## k8s-default-simontes-ea5ab2759b-771587743.ap-northeast-2.elb.amazonaws.com 같은 주소를 가집니다</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">LB_HOST</span><span class="o">=</span><span class="k">$(</span>kubectl get ingress/simon-test-alb -ojson <span class="p">|</span> jq -r .status.loadBalancer.ingress<span class="o">[</span>0<span class="o">]</span>.hostname<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ curl <span class="nv">$LB_HOST</span> --data <span class="s1">&#39;hello world&#39;</span>
</span></span><span class="line"><span class="cl">hello world
</span></span></code></pre></div><h2 id="후기">후기</h2>
<p>확실히 EKS는 ECS에 비해 훨씬 복잡합니다. 그만큼 세세한 컨트롤이 가능하고, AWS에 특화된 개념이 아니라는 것은 장점이라고 봅니다.</p>
<p>이번 글에서는 수동으로 처리해주는 부분이 꽤 있는데 다음에는 더 자동화(Terraform) 해보도록 하겠습니다.</p>
<h2 id="appendix">Appendix</h2>
<ul>
<li>예제 파일: <a href="/file/2022-03-31-2-simon-sample.zip">simon-sample.zip</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html">Amazon EKS의 애플리케이션 로드 밸런싱</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-cluster.html">Amazon EKS 클러스터 생성</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/fargate-getting-started.html">Amazon EKS를 사용하여 AWS Fargate 시작하기</a>
<ul>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/fargate-getting-started.html#fargate-gs-coredns">CoreDNS 업데이트</a></li>
</ul>
</li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-kubeconfig.html">Amazon EKS용 kubeconfig 생성</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/enable-iam-roles-for-service-accounts.html">클러스터에 대한 IAM OIDC 공급자 생성</a></li>
<li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/">AWS Load Balancer Controller</a>
<ul>
<li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/guide/ingress/annotations/">Ingress annotations</a></li>
</ul>
</li>
<li><a href="https://kubernetes.io/ko/docs/home/">쿠버네티스</a>
<ul>
<li><a href="https://kubernetes.io/ko/docs/concepts/workloads/pods/">파드</a></li>
<li><a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/replicaset/">레플리카셋</a></li>
<li><a href="https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/">디플로이먼트</a></li>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a></li>
</ul>
</li>
</ul>

      
      <hr>
      <div class='post-original'>
        원본 링크 : <a href='http://sixmen.com/ko/tech/2022-03-31-2-web-application-using-eks/' target='_blank'>http://sixmen.com/ko/tech/2022-03-31-2-web-application-using-eks/</a>
      </div>
      
    </div>

    <div class='col-lg-3 sidemenu'>
  <h4>Recent Posts</h4>
  <ul class="sidemenu-recent-list">
    
    <a href='/ko/2022-04-09-1-esm-problem/'>
      <li class="sidemenu-recent-item">ESM 삽질기</li>
    </a>
    
    <a href='/ko/2022-03-31-3-build-eks-cluster-with-terraform/'>
      <li class="sidemenu-recent-item">Terraform으로 EKS 구축하기</li>
    </a>
    
    <a href='/ko/2022-03-31-2-web-application-using-eks/'>
      <li class="sidemenu-recent-item">EKS를 사용해서 어플리케이션 서비스 하기</li>
    </a>
    
    <a href='/ko/2022-03-31-1-web-application-using-ecs/'>
      <li class="sidemenu-recent-item">ECS를 사용해서 어플리케이션 서비스 하기</li>
    </a>
    
  </ul>
  <hr>
  <h4>Tags</h4>
  <ul class="sidemenu-recent-list">
    
    <a href="/ko/tags/amazon-sqs/">
      <li class="sidemenu-recent-tags">amazon-sqs</li>
    </a>
    
    <a href="/ko/tags/analytics/">
      <li class="sidemenu-recent-tags">analytics</li>
    </a>
    
    <a href="/ko/tags/android/">
      <li class="sidemenu-recent-tags">android</li>
    </a>
    
    <a href="/ko/tags/aws/">
      <li class="sidemenu-recent-tags">aws</li>
    </a>
    
    <a href="/ko/tags/aws-batch/">
      <li class="sidemenu-recent-tags">aws-batch</li>
    </a>
    
    <a href="/ko/tags/aws-lambda/">
      <li class="sidemenu-recent-tags">aws-lambda</li>
    </a>
    
    <a href="/ko/tags/botkit/">
      <li class="sidemenu-recent-tags">botkit</li>
    </a>
    
    <a href="/ko/tags/croquis/">
      <li class="sidemenu-recent-tags">croquis</li>
    </a>
    
    <a href="/ko/tags/css/">
      <li class="sidemenu-recent-tags">css</li>
    </a>
    
    <a href="/ko/tags/data/">
      <li class="sidemenu-recent-tags">data</li>
    </a>
    
    <a href="/ko/tags/event/">
      <li class="sidemenu-recent-tags">event</li>
    </a>
    
    <a href="/ko/tags/front-end/">
      <li class="sidemenu-recent-tags">front-end</li>
    </a>
    
    <a href="/ko/tags/frontend/">
      <li class="sidemenu-recent-tags">frontend</li>
    </a>
    
    <a href="/ko/tags/github/">
      <li class="sidemenu-recent-tags">github</li>
    </a>
    
    <a href="/ko/tags/graphql/">
      <li class="sidemenu-recent-tags">graphql</li>
    </a>
    
    <a href="/ko/tags/ios/">
      <li class="sidemenu-recent-tags">ios</li>
    </a>
    
    <a href="/ko/tags/jenkins/">
      <li class="sidemenu-recent-tags">jenkins</li>
    </a>
    
    <a href="/ko/tags/jotai/">
      <li class="sidemenu-recent-tags">jotai</li>
    </a>
    
    <a href="/ko/tags/kubernetes/">
      <li class="sidemenu-recent-tags">kubernetes</li>
    </a>
    
    <a href="/ko/tags/log/">
      <li class="sidemenu-recent-tags">log</li>
    </a>
    
    <a href="/ko/tags/microservice/">
      <li class="sidemenu-recent-tags">microservice</li>
    </a>
    
    <a href="/ko/tags/mithril/">
      <li class="sidemenu-recent-tags">mithril</li>
    </a>
    
    <a href="/ko/tags/node.js/">
      <li class="sidemenu-recent-tags">node.js</li>
    </a>
    
    <a href="/ko/tags/nodejs/">
      <li class="sidemenu-recent-tags">nodejs</li>
    </a>
    
    <a href="/ko/tags/npm/">
      <li class="sidemenu-recent-tags">npm</li>
    </a>
    
    <a href="/ko/tags/react/">
      <li class="sidemenu-recent-tags">react</li>
    </a>
    
    <a href="/ko/tags/rest-api/">
      <li class="sidemenu-recent-tags">rest-api</li>
    </a>
    
    <a href="/ko/tags/serverless-architecture/">
      <li class="sidemenu-recent-tags">serverless-architecture</li>
    </a>
    
    <a href="/ko/tags/slack/">
      <li class="sidemenu-recent-tags">slack</li>
    </a>
    
    <a href="/ko/tags/stack/">
      <li class="sidemenu-recent-tags">stack</li>
    </a>
    
    <a href="/ko/tags/task-queue/">
      <li class="sidemenu-recent-tags">task-queue</li>
    </a>
    
    <a href="/ko/tags/thrift/">
      <li class="sidemenu-recent-tags">thrift</li>
    </a>
    
    <a href="/ko/tags/tutorial/">
      <li class="sidemenu-recent-tags">tutorial</li>
    </a>
    
    <a href="/ko/tags/typescript/">
      <li class="sidemenu-recent-tags">typescript</li>
    </a>
    
    <a href="/ko/tags/ui/">
      <li class="sidemenu-recent-tags">ui</li>
    </a>
    
    <a href="/ko/tags/vertical-align/">
      <li class="sidemenu-recent-tags">vertical-align</li>
    </a>
    
    <a href="/ko/tags/webpack/">
      <li class="sidemenu-recent-tags">webpack</li>
    </a>
    
    <a href="/ko/tags/%EB%A1%9C%EA%B7%B8/">
      <li class="sidemenu-recent-tags">로그</li>
    </a>
    
    <a href="/ko/tags/%EB%A7%88%EC%9D%B4%ED%81%AC%EB%A1%9C%EC%84%9C%EB%B9%84%EC%8A%A4/">
      <li class="sidemenu-recent-tags">마이크로서비스</li>
    </a>
    
    <a href="/ko/tags/%ED%8A%9C%ED%86%A0%EB%A6%AC%EC%96%BC/">
      <li class="sidemenu-recent-tags">튜토리얼</li>
    </a>
    
  </ul>
</div>

    <div class='col-12'>
      <hr>

      <div class='float-left'>
        
        <a class='btn btn-outline-primary' href='/ko/2022-03-31-1-web-application-using-ecs/' title='ECS를 사용해서 어플리케이션 서비스 하기'>&larr; 이전 글</a>
        
      </div>
      <div class='float-right'>
        
        <a class='btn btn-outline-primary' href='/ko/2022-03-31-3-build-eks-cluster-with-terraform/' title='Terraform으로 EKS 구축하기'>다음 글 &rarr;</a>
        
      </div>
      <div class='clearfix'></div>
      <hr>
      <div class='text-center'>
        <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "croquiscom-devblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
  </div>

</div>

<div class='container'>
  <hr>
  <footer>
    <p>
      &copy; 2012-2021 kakaostyle.com
      <span class='float-right text-muted'>
        powered by
        <a href='https://gohugo.io/' target='_blank'>Hugo</a>
        and
        <a href='https://getbootstrap.com/' target='_blank'>Bootstrap</a>
      </span>
    </p>
  </footer>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-48716672-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
  integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
  integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"
  integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
<script src="https://use.fontawesome.com/releases/v5.0.13/js/all.js"
  integrity="sha384-xymdQtn1n3lH2wcu0qhcdaOpQwyoarkgLVxC/wZ5q7h9gHtxICrpcaSUfygqZGOe" crossorigin="anonymous"></script>

</body>

</html>
