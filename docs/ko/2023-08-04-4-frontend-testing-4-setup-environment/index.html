<!DOCTYPE html>
<html lang='ko'>

<head>
  <meta charset='utf-8'>

  <title>프론트엔드 테스트 자동화 전략 - 4. 테스트 환경 구성</title>
  
  <meta name='author' content='kakaostyle.com'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>

  <meta property='og:title' content='프론트엔드 테스트 자동화 전략 - 4. 테스트 환경 구성' />
  <meta property='og:description' content='이전 글에서는 테스트 전략과, 테스트를 작성하는 방법들에 대해서 알아봤습니다. 하지만, 테스트를 실행하는 환경에 대해서는 스토리북을 사용한다고 가정했을 뿐, 구체적인 이야기를 진행하지는 않았습니다.
이번 글에서는, 테스트 프레임워크를 활용해서 테스트를 자동으로 실행할 수 있는 환경을 구성하는 방법에 대해 알아보겠습니다.
설명하는 내용의 특성상, 개념적인 이야기보다는 설정 파일에 대한 내용이 더 많습니다. 정독하는 것보다는, 실제로 테스트 환경을 구성하면서 매뉴얼 개념으로 읽어보시는게 더 효과적일 것이라 생각합니다.' />
  <meta property='og:type' content='article' />
  <meta property='og:url' content='https://devblog.kakaostyle.com/ko/2023-08-04-4-frontend-testing-4-setup-environment/' />
  
  <meta property='og:image' content='https://devblog.kakaostyle.com/img/og-image.png' />  
  

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
    integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
  <link href='/css/style.css?body=1' rel='stylesheet' type='text/css' media='all'>
  <link href='/css/syntax.css?body=1' rel='stylesheet' type='text/css' media='all'>
</head>

<body>
<div class='hp-navbar-top'>
  <div class='container'>
    <div class='row'>
      <div class='col-12'>
        <nav class='hp-nav'>
          <span>
            <a href='/' class='logo-a-tag'>
              <img class='hp-navbar-logo' src='/img/logo-kakaostyle.png'>
              <span class='hp-navbar-logo-font'>기술 블로그</span>
            </a>
          </span>
        </nav>
        <div class='float-right hp-navbar-top-link'>
          <a class='hp-nav-item' href='https://kakaostyle.com' target='_blank'>
            <img class='icon' src='/img/kakaostyle-icon.png'>
          </a>
          <a class='hp-nav-item' href='https://github.com/croquiscom' target='_blank'>
            <img class='icon' src='/img/github-icon.svg'>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<div class='hp-navbar'>
  <div class='hp-navbar-bgcolor'>
    <div class='container'>
      <div class='text-center'>
        <div class='hp-navbar-title'>프론트엔드 테스트 자동화 전략 - 4. 테스트 환경 구성</div>
      </div>
    </div>
  </div>
</div>


<div class='container'>

  <div class='row'>
    <div class='col-12'>
      <div class='post-header'>
        <div class='post-tags'>
          

<ul class='tag_box inline'>
  <li><i class='fas fa-tags'></i></li>
  
  <li>
    <a href='/ko/tags/frontend'>
      Frontend
      <span>7</span>
    </a>
  </li>
  
  <li>
    <a href='/ko/tags/testing'>
      Testing
      <span>5</span>
    </a>
  </li>
  
</ul>

        </div>
        <div class='float-right'>
          
          <div class='post-author'>
            <i class='fas fa-pencil-alt'></i>
            <span>Martin(유덕남)</span>
          </div>
          
          <div class='post-date'>
            <i class='fas fa-calendar-alt'></i>
            <span>04 August 2023</span>
          </div>
        </div>
      </div>
    </div>

    <div class='col-12 col-lg-9'>
      <p>이전 글에서는 테스트 전략과, 테스트를 작성하는 방법들에 대해서 알아봤습니다. 하지만, 테스트를 실행하는 환경에 대해서는 스토리북을 사용한다고 가정했을 뿐, 구체적인 이야기를 진행하지는 않았습니다.</p>
<p>이번 글에서는, 테스트 프레임워크를 활용해서 테스트를 자동으로 실행할 수 있는 환경을 구성하는 방법에 대해 알아보겠습니다.</p>
<p>설명하는 내용의 특성상, 개념적인 이야기보다는 설정 파일에 대한 내용이 더 많습니다. 정독하는 것보다는, 실제로 테스트 환경을 구성하면서 매뉴얼 개념으로 읽어보시는게 더 효과적일 것이라 생각합니다.</p>
<h2 id="개요">개요</h2>
<p>테스트 프레임워크는 테스트에 필요한 여러 함수들과 실행 환경을 만들어주고, 프로젝트에 존재하는 테스트 코드를 모아서 실행해줍니다. 모든 테스트를 실행한 뒤 결과를 제공해줘서, 코드에 어떤 이슈가 있는지 바로 확인할 수 있습니다.</p>
<p>GitHub Actions는 PR이 올라오거나, 커밋이 푸시될 때마다 테스트를 실행해줘서, 배포하거나 머지하기 전에 문제가 없는지 자동으로 체크할 수 있습니다.</p>
<p>특히, 자동으로 테스트를 실행함으로써 지속적인 통합과 배포(CI/CD)를 안정적으로 구현할 수 있습니다. 코드 변경 사항이 발생하면 GitHub Actions를 통해 자동으로 테스트가 실행되고, 테스트 결과를 통해 변경 사항의 유효성을 검증할 수 있습니다. 이를 통해 빠른 피드백을 받을 수 있고, 프로젝트의 품질을 유지하면서 안정적인 배포를 실현할 수 있습니다.</p>
<h2 id="테스트-프레임워크의-종류">테스트 프레임워크의 종류</h2>
<p>프론트엔드에서 테스트 프레임워크는 크게 JS 테스트 프레임워크, E2E 테스트 프레임워크 둘로 나누어집니다.</p>
<p>JS 테스트 프레임워크는 실제 브라우저를 띄우지 않고, jsdom과 같이 브라우저를 흉내내는 도구를 사용해 Node.js 기반으로 실행되는 테스트 프레임워크입니다. 브라우저를 사용하지 않기 때문에 테스트를 진행하는 속도가 매우 빠릅니다. 하지만, webpack 등 번들러 설정과 별개로 빌드 환경을 세팅해야 하고, 웹 브라우저 API를 모킹해야 한다는 단점이 있습니다.</p>
<p>E2E 테스트 프레임워크는 이미 빌드된 프로젝트를 웹 브라우저에서 실제로 띄워서, 사용자의 동작을 흉내내는 식으로 테스트를 수행합니다. 이미 구성된 빌드 환경을 사용하고, 그 위에서 테스트를 진행하기 때문에 구성하는 과정이 쉬운 편입니다. 하지만 실제로 웹 브라우저를 띄우기 때문에, JS 테스트 프레임워크보다는 느린 편입니다.</p>
<p>이렇게 둘의 특성이 크게 갈리기 때문에, 개발 난이도나, 테스트 정확도, 테스트 시간을 고려해서 선택이 필요합니다.</p>
<h2 id="테스트-프레임워크">테스트 프레임워크</h2>
<h3 id="storybooktest-runner">storybook/test-runner</h3>
<p><a href="https://github.com/storybookjs/test-runner">storybook/test-runner</a>는 웹 브라우저를 실제로 띄워서, 스토리북의 스토리를 하나씩 실행해보는 테스트 실행 도구입니다. 스토리북 설정을 그대로 사용할 수 있어서, 설정하기는 정말 간단합니다.</p>
<p>기존에 빌드해둔 스토리북에 의존하기 때문에, 스토리북 빌드를 진행하거나, 스토리북 서버를 띄운 상태에서 테스트를 진행해야 한다는 특징이 있습니다.</p>
<ul>
<li><code>npm install @storybook/test-runner --save-dev</code> 로 설치를 진행하고,</li>
<li><code>npm run storybook</code> 으로 스토리북 서버를 켠 뒤</li>
<li><code>npx test-storybook --url http://localhost:7001</code> 과 같이 서버에 접속해서 테스트를 진행하도록 실행만 해주면 됩니다.</li>
</ul>
<p>설정은 매우 쉽지만, <a href="https://playwright.dev/">playwright</a> (E2E 테스트 프레임워크)를 사용해서 웹 브라우저를 띄워서 테스트를 돌리기 때문에, 성능이 느릴 수 있습니다.</p>
<p>특히 CPU와 메모리를 크게 사용하기 때문에 (메모리를 32GB 넘게 사용하는 일도 많습니다), 문제가 되는 경우 <code>--maxWorkers 4</code> 와 같은 옵션을 지정해서 동시 실행 개수를 제한해야 합니다.</p>
<p>속도 문제가 체감이 되지 않는다면, storybook/test-runner를 사용하는 것이 제일 쉽고 빠르기 때문에 권장하고 싶습니다. <code>--watch</code> 모드를 사용한다면 변경된 부분만 다시 실행할 수 있기 때문에 성능 이슈를 크게 줄일 수 있습니다.</p>
<h3 id="jest">jest</h3>
<p><a href="https://jestjs.io/">jest</a>는 자바스크립트 개발에서 제일 많이 쓰이는 테스트 프레임워크입니다. vitest 등 여러 대체제가 있지만, 현재로써는 가장 인기 있고, 성능이 좋기 때문에 jest를 검토해봤습니다.</p>
<p>jest는 별도로 테스트 환경 설정이 필요한데, 설정에서 webpack과 다른 개념이 많기 때문에 조금 난이도가 있는 편입니다.</p>
<ul>
<li>webpack에서 쓰이는 loader (<code>ts-loader</code>, <code>babel-loader</code>, …)같은 개념이 jest에는 없기 때문에 이런 내용들을 mock 파일로 대체하거나, 별도의 transformer를 설치하는 작업이 필요합니다.
<ul>
<li><a href="https://jestjs.io/docs/webpack">https://jestjs.io/docs/webpack</a> 도 참고해주세요.</li>
</ul>
</li>
<li>실제 웹 브라우저를 사용하지 않기 때문에 브라우저 환경에 있는 기능들을 전부 다시 구현해야 합니다. <code>jsdom</code>이 이런 역할을 어느정도 수행해주지만, jsdom이 처리해주지 않는 API들은 별도로 구현해야 하기 때문에 번거롭습니다.</li>
<li>jest 자체적으로도 이런저런 버그가 많기 때문에 우회할 수 있는 방법을 찾아봐야 합니다. 대표적으로 Node.js 특정 버전 이후로 메모리가 계속 샌다는 이슈가 있고, jest는 이를 우회하기 위해서 테스트 프로세스를 주기적으로 재시작하는 기능을 가지고 있습니다.</li>
</ul>
<p>Next.js에서도 jest를 위한 설정을 제공하고 있으므로, Next.js 프로젝트를 사용한다면 참고해주세요. (<a href="https://nextjs.org/docs/app/building-your-application/testing/jest">#</a>)</p>
<p>파트너센터 프로젝트에서는 테스트 코드가 상당히 많아서, <code>@storybook/test-runner</code>로는 로컬에서 테스트가 10분-15분 이상 소요되는 일도 잦았기 때문에, 성능이 제일 좋은 jest를 사용해서 스토리북 테스트를 진행하기로 했습니다.</p>
<h3 id="vitest">vitest</h3>
<p><a href="https://vitest.dev/">vitest</a>는 vite의 설정을 그대로 사용할 수 있는 테스트 프레임워크입니다. 비록 프로젝트에서 vite를 사용하고 있지는 않지만, jest보다는 설정이 훨씬 간편하고, jest가 가지고 있는 버그들도 없기 때문에 검토해봤습니다.</p>
<p>하지만, jest보다 3배정도 느려서, 성능 차이가 꽤 났기 때문에, jest를 그대로 사용하기로 했습니다.</p>
<h2 id="jest-테스트-작성">jest 테스트 작성</h2>
<p>jest 테스트 작성 방법은 <code>describe</code>, <code>it</code>, <code>expect</code> 등을 사용해서 작성할 수 있는데, 관련된 내용은 기존 글에서 이미 다뤘기 때문에 넘어갑니다.</p>
<p>jest와 react-testing-library를 사용하면 아래와 같이 스토리북을 그대로 실행하는 테스트를 작성할 수 있습니다. 이런 방법을 통해서 별도로 .test.tsx를 작성하지 않고 스토리북을 테스트하는 환경을 구성할 수 있다면, 별다른 작업 없이도 테스트 자동화가 가능해서 유용할 것이라고 생각했습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// Main.test.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">composeStories</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@storybook/testing-react&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">render</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@testing-library/react&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">React</span> <span class="kr">from</span> <span class="s1">&#39;react&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">file</span> <span class="kr">from</span> <span class="s1">&#39;./Main.stories&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">stories</span> <span class="o">=</span> <span class="nx">composeStories</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Main&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">stories</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">key</span><span class="p">,</span> <span class="nx">Story</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">it</span><span class="p">(</span><span class="nx">Story</span><span class="p">.</span><span class="nx">storyName</span> <span class="o">??</span> <span class="nx">key</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="p">{</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">unmount</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">render</span><span class="p">(&lt;</span><span class="nt">Story</span> <span class="p">/&gt;);</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">Story</span><span class="p">.</span><span class="nx">play</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">await</span> <span class="nx">Story</span><span class="p">.</span><span class="nx">play</span><span class="o">?</span><span class="p">.({</span> <span class="nx">canvasElement</span>: <span class="kt">container</span><span class="p">,</span> <span class="nx">args</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unmount</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><h2 id="jest-환경-구성하기">jest 환경 구성하기</h2>
<p>먼저, 아래 명령으로 jest에서 사용할 여러 패키지들을 설치하고 설정 파일을 생성합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">npm install jest jest-environment-jsdom ts-jest@types/jest --save-dev
</span></span><span class="line"><span class="cl">npm install @testing-library/jest-dom @testing-library/react @testing-library/user-event --save-dev
</span></span><span class="line"><span class="cl">npx jest --init
</span></span></code></pre></div><h3 id="modulenamemapper">moduleNameMapper</h3>
<p>빌드가 정상적으로 이루어지게 하기 위해서는 웹팩과 비슷한 빌드 환경을 구성해야 합니다.</p>
<p>많은 프로젝트에서 TypeScript의 alias 기능을 사용하고 있을텐데요, ts-jest에서 제공하는 <code>pathsToModuleNameMapper</code> 를 사용하면 tsconfig.json을 읽어서 자동으로 alias에 대응하는 설정을 생성해줍니다.</p>
<p>또한, 웹팩에서는 .png, .jpg, .css와 같은 파일을 그대로 import해올 수 있는데, jest는 Node.js 기반으로 돌아가기 때문에 기본적으로는 불가능합니다. 따라서, 이런 확장자가 감지되면 fileMock.js가 대신 로딩되도록 이름을 바꿔주어야 합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// jest.config.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">pathsToModuleNameMapper</span> <span class="p">}</span> <span class="o">=</span> <span class="kr">require</span><span class="p">(</span><span class="s1">&#39;ts-jest&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">module</span><span class="nx">.exports</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">module</span><span class="nx">NameMapper</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;\\.(jpg|jpeg|png|gif|eot|otf|webp|svg)$&#39;</span><span class="o">:</span> <span class="s1">&#39;&lt;rootDir&gt;/mocks/fileMock.js&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;\\.(css|scss)$&#39;</span><span class="o">:</span> <span class="s1">&#39;&lt;rootDir&gt;/mocks/fileMock.js&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span><span class="nx">pathsToModuleNameMapper</span><span class="p">(</span><span class="nx">compilerOptions</span><span class="p">.</span><span class="nx">paths</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// fileMock.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">module</span><span class="nx">.exports</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span></code></pre></div><h3 id="babel--swc">babel / swc</h3>
<p>이어서, JSX와 import/export 문법을 사용할 수 있도록 babel이나 swc를 사용해야 합니다. swc가 babel에 비해 훨씬 빠르지만, emotion 플러그인을 사용하는 경우에는 ARM 기반 맥에서 오류가 발생하고 있어서, 분기 처리를 해두었습니다.</p>
<ul>
<li><code>npm install @swc/core @swc/helpers @swc/jest @swc/plugin-emotion babel-jest --save-dev</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// jest.config.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">module</span><span class="nx">.exports</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">transform</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ARMv8에서 @swc/jest가 제대로 동작하지 않는 이슈 존재
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s1">&#39;.+\\.(t|j)sx?$&#39;</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">arch</span> <span class="o">===</span> <span class="s1">&#39;arm64&#39;</span> <span class="o">?</span> <span class="p">[</span><span class="s1">&#39;babel-jest&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">configFile</span><span class="o">:</span> <span class="s1">&#39;./.babelrc.json&#39;</span> <span class="p">}]</span> <span class="o">:</span> <span class="s1">&#39;@swc/jest&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// .babelrc.json
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;presets&#34;</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;@babel/preset-env&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;useBuiltIns&#34;</span><span class="o">:</span> <span class="s2">&#34;usage&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;corejs&#34;</span><span class="o">:</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;@babel/preset-react&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;@babel/preset-typescript&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;plugins&#34;</span><span class="o">:</span> <span class="p">[[</span><span class="s2">&#34;@emotion&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;autoLabel&#34;</span><span class="o">:</span> <span class="s2">&#34;always&#34;</span> <span class="p">}]]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// .swcrc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;$schema&#34;</span><span class="o">:</span> <span class="s2">&#34;https://json.schemastore.org/swcrc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;jsc&#34;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;parser&#34;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;syntax&#34;</span><span class="o">:</span> <span class="s2">&#34;typescript&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;tsx&#34;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;decorators&#34;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;dynamicImport&#34;</span><span class="o">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;target&#34;</span><span class="o">:</span> <span class="s2">&#34;es5&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;externalHelpers&#34;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;experimental&#34;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;plugins&#34;</span><span class="o">:</span> <span class="p">[[</span><span class="s2">&#34;@swc/plugin-emotion&#34;</span><span class="p">,</span> <span class="p">{}]]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;minify&#34;</span><span class="o">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="jsdom과-브라우저-모킹">jsdom과 브라우저 모킹</h3>
<p>이어서, jest에서 React 컴포넌트 테스트를 진행하려면 브라우저 환경을 흉내낼 수 있어야 합니다.</p>
<p>jsdom이 대부분의 브라우저 API를 제공해주긴 하지만, 추가로 필요한 내용들은 테스트 환경이 구성될 때마다 실행되는 파일인 <code>mocks/setupJest.ts</code> 에 넣어두었습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// jest.config.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">module</span><span class="nx">.exports</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">testEnvironment</span><span class="o">:</span> <span class="s1">&#39;jsdom&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">setupFilesAfterEnv</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;&lt;rootDir&gt;/mocks/setupJest.ts&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>이제, 앱에서 사용하는 다른 API 목들과, 필요한 설정들을 <code>setupJest.ts</code> 안에 구성합니다. 아래는 프로젝트에서 필요한 내용을 하나씩 구성한 것이기 때문에, 만약 아래 내용이 없어도 정상적으로 동작한다면 빼도 무방합니다.</p>
<ul>
<li><a href="https://github.com/trurl-master/jsdom-testing-mocks">https://github.com/trurl-master/jsdom-testing-mocks</a></li>
<li><a href="https://github.com/hustcc/jest-canvas-mock">https://github.com/hustcc/jest-canvas-mock</a></li>
<li><a href="https://github.com/dumbmatter/fakeIndexedDB">https://github.com/dumbmatter/fakeIndexedDB</a></li>
<li><code>npm install jsdom-testing-mocks jest-canvas-mock fake-indexeddb --save-dev</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// mocks/setupJest.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">mockViewport</span><span class="p">,</span> <span class="nx">mockIntersectionObserver</span><span class="p">,</span> <span class="nx">mockResizeObserver</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;jsdom-testing-mocks&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">initialize</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;msw-storybook-addon&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">setGlobalConfig</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@storybook/testing-react&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="s1">&#39;regenerator-runtime/runtime&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="s1">&#39;whatwg-fetch&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="s1">&#39;fake-indexeddb/auto&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="s1">&#39;jest-canvas-mock&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="s1">&#39;@testing-library/jest-dom&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">sbConfig</span> <span class="kr">from</span> <span class="s1">&#39;./sbConfig&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">mockViewport</span><span class="p">({</span> <span class="nx">width</span><span class="o">:</span> <span class="s1">&#39;1280px&#39;</span><span class="p">,</span> <span class="nx">height</span><span class="o">:</span> <span class="s1">&#39;1024px&#39;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nx">mockIntersectionObserver</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">mockResizeObserver</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ref: https://jestjs.io/docs/manual-mocks#mocking-methods-which-are-not-implemented-in-jsdom
</span></span></span><span class="line"><span class="cl"><span class="c1">// ref: https://github.com/jsdom/jsdom/issues/2524
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;TextEncoder&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">writable</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">value</span>: <span class="kt">util.TextEncoder</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;TextDecoder&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">writable</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">value</span>: <span class="kt">util.TextDecoder</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">window</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">scrollIntoView</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nb">window</span><span class="p">.</span><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">scrollTo</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">revokeObjectURL</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">initialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">setGlobalConfig</span><span class="p">(</span><span class="nx">sbConfig</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 스토리북 내부에서는 비동기 API (await findByText()) 을 전제하기 때문에
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// act를 사용하지 않아도 괜찮으므로 경고 메시지를 제거합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">(</span><span class="kr">global</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">).</span><span class="nx">IS_REACT_ACT_ENVIRONMENT</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// mocks/sbConfig.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1">// 테스트 환경에서 사용할 스토리북 전역 설정을 여기에 추가합니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">parameters</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">decorators</span> <span class="o">=</span> <span class="p">[];</span>
</span></span></code></pre></div><p>만약 i18next를 사용하는 경우에는 번역 데이터에 영향받지 않도록, 아래와 같이 CI 모드로 변경하는 것을 권장합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// mocks/setupJest.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="nx">i18next</span> <span class="kr">from</span> <span class="s1">&#39;i18next&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">initReactI18next</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;react-i18next&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">i18next</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">initReactI18next</span><span class="p">).</span><span class="nx">init</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">lng</span><span class="o">:</span> <span class="s1">&#39;cimode&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">fallbackLng</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><h3 id="requirecontext-대응">require.context 대응</h3>
<p>웹팩에서는 프로젝트 디렉터리에서 조건에 맞는 모든 파일들을 가져올 수 있게 하는 <a href="https://webpack.js.org/guides/dependency-management/#requirecontext">require.context</a> 라는 기능을 지원하고 있습니다. 만약 require.context를 사용하고 있다면, jest에서는 제공하지 않는 기능이기 때문에, 사용하는 쪽에서 분기 처리가 필요합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// Webpack 환경과 Node.js 환경 모두 대응이 필요하고, Webpack의 경우 &#39;require.context&#39; 내부의
</span></span></span><span class="line"><span class="cl"><span class="c1">// 정규표현식을 코드에 같이 묻어두어야 하기 때문에 별도로 함수로 분리할 수가 없었습니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">__webpack_require__</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">fixtures_context</span> <span class="o">=</span> <span class="kr">require</span><span class="p">.</span><span class="nx">context</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="sr">/^\.\/(?!node_modules)[^/]+\/.+\.fixtures\.tsx?$/i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">fixtures_context</span><span class="p">.</span><span class="nx">keys</span><span class="p">().</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">filename</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">imported</span> <span class="o">=</span> <span class="nx">fixtures_context</span><span class="p">(</span><span class="nx">filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">processFixtureFile</span><span class="p">(</span><span class="nx">imported</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Webpack에서는 &#39;require&#39; 함수 호출을 모두 감지해서 조건에 맞는 파일을 모두 번들링하기 때문에,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// require(&#39;../&#39; + filename) 패턴을 인식해서 프로젝트에 있는 모든 파일을 번들링하게 됩니다!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 이쪽 코드는 Node.js 환경에서만 실행될 것을 알기 때문에, eval을 통해서 Webpack이 처리할 수 없도록
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 막았습니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="nx">glob</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;require&#39;</span><span class="p">)(</span><span class="s1">&#39;glob&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;require&#39;</span><span class="p">)(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">glob</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="s1">&#39;**/*.fixtures.{ts,tsx}&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cwd</span>: <span class="kt">path.resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="nx">files</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">filename</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">imported</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;require&#39;</span><span class="p">)(</span><span class="s1">&#39;../&#39;</span> <span class="o">+</span> <span class="nx">filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">processFixtureFile</span><span class="p">(</span><span class="nx">imported</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="jest-메모리-누수">jest 메모리 누수</h3>
<p>Node.js 16.10 버전 이후로 jest에서 메모리가 누수되는 문제가 있는데, 해결되지 않은 상태기 때문에 jest에서는 메모리 사용량이 특정 용량을 넘어가면, 워커 프로세스를 재시작하는 옵션을 제공합니다. (<a href="https://github.com/jestjs/jest/issues/11956">#</a>)</p>
<blockquote>
<p>(2024.07.19) Node.js 20.10.0에서 수정되었습니다.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// jest.config.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">module</span><span class="nx">.exports</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// https://github.com/jestjs/jest/issues/11956
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">workerIdleMemoryLimit</span><span class="o">:</span> <span class="s1">&#39;1G&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><h3 id="storiestsx를-테스트로-자동으로-변환하기">.stories.tsx를 테스트로 자동으로 변환하기</h3>
<p>이렇게 해서 jest 환경 구성까지는 마쳤는데, 현재로써는 스토리북 파일 (<code>stories.tsx</code>) 마다 테스트 파일 (<code>test.tsx</code>)을 따로 만들어야 하기 때문에 번거롭다고 생각했습니다.</p>
<p>그래서, <code>.stories.tsx</code> 를 자동으로 테스트로 변환시킬 수 있는 방법을 찾아봤습니다.</p>
<p>먼저, testMatch를 수정해서 <code>stories.tsx</code> 도 테스트 파일로 잡히도록 수정합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// jest.config.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">module</span><span class="nx">.exports</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">testMatch</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;**/__tests__/**/*.[jt]s?(x)&#39;</span><span class="p">,</span> <span class="s1">&#39;**/?(*.)+(spec|test).[tj]s?(x)&#39;</span><span class="p">,</span> <span class="s1">&#39;**/?(*.)+(stories).[tj]s?(x)&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>그 뒤에, jest의 transformer 기능을 사용해서, <code>.stories.tsx</code>를 읽었을 때 babel을 돌린 뒤 <code>runStorybookTests</code> 함수를 실행해서 테스트로 변환하도록 작업했습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// mocks/sbTransformer.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">createTransformer</span>: <span class="kt">babelCreateTransformer</span> <span class="p">}</span> <span class="o">=</span> <span class="kr">require</span><span class="p">(</span><span class="s1">&#39;babel-jest&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">createTransformer</span><span class="p">(</span><span class="nx">userOptions</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">babel</span> <span class="o">=</span> <span class="nx">babelCreateTransformer</span><span class="p">(</span><span class="nx">userOptions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">process</span><span class="p">(</span><span class="nx">sourceText</span><span class="p">,</span> <span class="nx">sourcePath</span><span class="p">,</span> <span class="nx">config</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">babelResult</span> <span class="o">=</span> <span class="nx">babel</span><span class="p">.</span><span class="nx">process</span><span class="p">(</span><span class="nx">sourceText</span><span class="p">,</span> <span class="nx">sourcePath</span><span class="p">,</span> <span class="nx">config</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// babel-jest에서 반환한 결과를 꺼내서 변환
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kr">const</span> <span class="nx">testCode</span> <span class="o">=</span> <span class="sb">`&#34;use strict&#34;;
</span></span></span><span class="line"><span class="cl"><span class="sb">var _exportValues = (function (exports) {
</span></span></span><span class="line"><span class="cl"><span class="sb"></span><span class="si">${</span><span class="nx">babelResult</span><span class="p">.</span><span class="nx">code</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">return exports;
</span></span></span><span class="line"><span class="cl"><span class="sb">})({});
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">Object.assign(exports, _exportValues);
</span></span></span><span class="line"><span class="cl"><span class="sb">require(&#39;mocks/sbTest&#39;).runStorybookTests(_exportValues);
</span></span></span><span class="line"><span class="cl"><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span> <span class="nx">code</span>: <span class="kt">testCode</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">module</span><span class="nx">.exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">createTransformer</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// mocks/sbTest.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">runStorybookTests</span><span class="p">(</span><span class="nx">file</span>: <span class="kt">any</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 후술
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// jest.config.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">module</span><span class="nx">.exports</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">transform</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;.+\\.stories\\.(t|j)sx?$&#39;</span><span class="o">:</span> <span class="s1">&#39;&lt;rootDir&gt;/mocks/sbTransformer.js&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>하지만, 이 방식을 통해 스토리북 파일을 테스트로 바꾸게 된다면, <code>test.tsx</code>에서 <code>stories.tsx</code>를 임포트할 때에도 스토리북의 내용이 테스트로 등록된다는 점은 유의해야 합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// Component.test.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1">// 단순히 임포트를 했을 뿐인데, 스토리북의 스토리들이 알아서 테스트로 바뀝니다!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">Stories</span> <span class="kr">from</span> <span class="s1">&#39;./Component.stories&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Component&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">});</span>
</span></span></code></pre></div><h3 id="스토리북-jest-환경의-한계">스토리북 jest 환경의 한계</h3>
<p>스토리북에서는 <a href="https://www.npmjs.com/package/@storybook/react-docgen-typescript-plugin">react-docgen-typescript-plugin</a> 이라는 웹팩 플러그인을 사용해서 컴포넌트의 타입 정보를 자동으로 얻어옵니다.</p>
<p>이는 스토리북에서 controls나 타입 정보를 표시하는 것뿐만 아니라, <code>onClick</code> 과 같은 prop에 자동으로 mock 함수를 집어넣는데도 사용됩니다.</p>
<p>하지만 jest에서는 이 웹팩 플러그인을 사용할 수 없기 때문에, mock 함수를 자동으로 넣어줄 수 없습니다. mock 함수가 누락되면 스토리가 정상적으로 실행되지 않는 경우도 많기 때문에, jest로 스토리북을 실행하려면 해결이 필요했습니다.</p>
<p>여러 방법을 찾아보았지만, 간단한 해결책은 보이지 않아서, <code>.stories.tsx</code> 에 <code>argTypes</code> 를 사용해서 함수가 필요함을 나타내도록 했습니다. 또한, 테스트 실행이 불가능한 경우 <code>skipTest</code> parameter를 사용해서 건너뛸 수 있도록 했습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// Component.stories.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">component</span>: <span class="kt">Component</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">argTypes</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 이렇게 명시적으로 onClose prop이 action (콜백 함수)임을 나타냅니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 모든 스토리북에서 관련된 작업이 필요합니다!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">onClose</span><span class="o">:</span> <span class="p">{</span> <span class="nx">action</span><span class="o">:</span> <span class="s1">&#39;onClose&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">parameters</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 스토리북의 테스트가 불가능한 경우 이렇게 parameters에 skipTest를 추가해서
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 테스트를 건너뜁니다.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">skipTest</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">as</span> <span class="nx">ComponentMeta</span><span class="p">&lt;</span><span class="nt">typeof</span> <span class="na">Component</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// mocks/sbTest.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nx">argTypes</span> <span class="o">??</span> <span class="p">{}).</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="nx">value</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">action</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">args</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>이를 모두 종합하면, sbTest.tsx는 아래와 같은 코드를 가지고 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// mocks/sbTest.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">composeStories</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@storybook/testing-react&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">cleanup</span><span class="p">,</span> <span class="nx">render</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@testing-library/react&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">React</span> <span class="kr">from</span> <span class="s1">&#39;react&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">runStorybookTests</span><span class="p">(</span><span class="nx">file</span>: <span class="kt">any</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="k">default</span><span class="o">?</span><span class="p">.</span><span class="nx">title</span> <span class="o">??</span> <span class="nx">file</span><span class="p">.</span><span class="k">default</span><span class="o">?</span><span class="p">.</span><span class="nx">component</span><span class="o">?</span><span class="p">.</span><span class="nx">displayName</span> <span class="o">??</span> <span class="nx">file</span><span class="p">.</span><span class="k">default</span><span class="o">?</span><span class="p">.</span><span class="nx">component</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">stories</span> <span class="o">=</span> <span class="nx">composeStories</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">describe</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">stories</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">key</span><span class="p">,</span> <span class="nx">Story</span><span class="p">]</span><span class="o">:</span> <span class="p">[</span><span class="kt">string</span><span class="p">,</span> <span class="kt">any</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">Story</span><span class="p">.</span><span class="nx">parameters</span><span class="p">.</span><span class="nx">skipTest</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">it</span><span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="nx">Story</span><span class="p">.</span><span class="nx">storyName</span> <span class="o">??</span> <span class="nx">key</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">it</span><span class="p">(</span><span class="nx">Story</span><span class="p">.</span><span class="nx">storyName</span> <span class="o">??</span> <span class="nx">key</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="p">...</span><span class="nx">Story</span><span class="p">.</span><span class="nx">args</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nx">argTypes</span> <span class="o">??</span> <span class="p">{}).</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">((</span><span class="nx">value</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">action</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">args</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="kr">const</span> <span class="p">{</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">unmount</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">render</span><span class="p">(&lt;</span><span class="nt">Story</span> <span class="p">{</span><span class="na">...args</span><span class="p">}</span> <span class="p">/&gt;);</span>
</span></span><span class="line"><span class="cl">          <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">Story</span><span class="p">.</span><span class="nx">play</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">await</span> <span class="nx">Story</span><span class="p">.</span><span class="nx">play</span><span class="o">?</span><span class="p">.({</span> <span class="nx">canvasElement</span>: <span class="kt">container</span><span class="p">,</span> <span class="nx">args</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">unmount</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">cleanup</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="설정-마무리">설정 마무리</h3>
<p>이렇게 하면 jest 환경 구성과, 스토리북 테스트 구성이 모두 완료됩니다. 상당히 설정할 내용이 많았습니다!</p>
<p>마지막으로, <code>npm test</code>를 실행했을 때 <code>jest</code>가 실행되도록 <code>package.json</code>만 변경해주면 마무리됩니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="c1">// package.json
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;scripts&#34;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;test&#34;</span><span class="o">:</span> <span class="s2">&#34;jest&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>이렇게 구성했을 때, 로컬에서 테스트를 돌리면 2분 (120초) 내외로 모든 테스트가 완료되는걸 볼 수 있었습니다. 이외에도, <code>--watch</code> 모드를 사용하면 수정된 내용에 관련된 테스트만 다시 돌릴 수 있어서 성능 향상에 도움이 됩니다.</p>
<h2 id="github-actions-구성">GitHub Actions 구성</h2>
<p>이렇게 테스트를 <code>npm test</code>를 통해 자동으로 돌릴 수 있는 환경이 구성되었으면, 이제 GitHub Actions와 같은 CI 환경에서 실행해서, PR이 올라오거나 커밋이 푸시될 때마다 테스트를 실행할 수 있습니다.</p>
<p>설정도 매우 간단해서, 이미 사용하고 있던 GitHub Actions 설정이 있다면 <code>npm test</code>를 실행하도록 바꿔주기만 하면 끝납니다.</p>
<p>하지만 성능 문제가 심각한 편입니다. GitHub Actions에서 제공해주는 컴퓨터는 CPU를 2쓰레드밖에 제공해주지 않기 때문에, 로컬에서는 2분으로 끝날게 거의 30분 가까이 걸리게 됩니다. 더 성능이 좋은 인스턴스를 사용하는 옵션은 아직 베타라서 사용하기가 어려웠습니다. (<a href="https://docs.github.com/en/actions/using-github-hosted-runners/using-larger-runners">#</a>)</p>
<blockquote>
<p>(2024.07.19) 현재는 공개적으로 사용가능합니다. 이와 별개로 카카오스타일에서는 현재 GitHub가 제공하는 러너 대신 자체 러너를 사용해 상황에 맞출 수 있게 됐습니다. 그럼에도 불구하고 한계는 있어 아래 내용이 여전히 의미가 있습니다.</p>
</blockquote>
<p>대신, jest를 포함한 여러 프레임워크들은 <code>shard</code>라는 기능을 제공합니다. 테스트를 원하는 개수로 나눠서, 각 컴퓨터에서 shard를 실행하면 모든 테스트가 수행되는 식으로 병렬화를 가능하게 해줍니다.</p>
<p>즉, 아래 명령을 3대의 컴퓨터에서 하나씩 동시에 실행하면, 프로젝트 전체에 대해서 테스트가 완료되는 구조입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">npm <span class="nb">test</span> -- -w <span class="m">2</span> --shard<span class="o">=</span>1/3
</span></span><span class="line"><span class="cl">npm <span class="nb">test</span> -- -w <span class="m">2</span> --shard<span class="o">=</span>2/3
</span></span><span class="line"><span class="cl">npm <span class="nb">test</span> -- -w <span class="m">2</span> --shard<span class="o">=</span>3/3
</span></span></code></pre></div><p>또한, GitHub Actions에서는 <a href="https://docs.github.com/en/actions/using-jobs/using-a-matrix-for-your-jobs">matrix</a>라는 기능을 지원합니다. 이 기능을 사용하면 동일한 GitHub Actions 스크립트를 서로 다른 설정으로 병렬로 돌릴 수 있게 해줍니다.</p>
<p><img src="/img/content/2023-08-04-4/1.png" alt="1.png"></p>
<p>shard와 matrix를 사용해서, 아래와 같이 GitHub Actions을 8병렬로 돌리게 설정했습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="nx">jobs</span>:
</span></span><span class="line"><span class="cl">  <span class="kt">prepare</span><span class="o">-</span><span class="nx">cache</span>:
</span></span><span class="line"><span class="cl">    <span class="kt">runs</span><span class="o">-</span><span class="nx">on</span>: <span class="kt">ubuntu</span><span class="o">-</span><span class="nx">latest</span>
</span></span><span class="line"><span class="cl">    <span class="nx">steps</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="nx">name</span>: <span class="kt">Checkout</span>
</span></span><span class="line"><span class="cl">        <span class="nx">uses</span>: <span class="kt">actions</span><span class="o">/</span><span class="nx">checkout</span><span class="kd">@v3</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="nx">name</span>: <span class="kt">Setup</span> <span class="nx">Node</span><span class="p">.</span><span class="nx">js</span>
</span></span><span class="line"><span class="cl">        <span class="nx">uses</span>: <span class="kt">actions</span><span class="o">/</span><span class="nx">setup</span><span class="o">-</span><span class="nx">node</span><span class="kd">@v3</span>
</span></span><span class="line"><span class="cl">        <span class="kd">with</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="nx">node</span><span class="o">-</span><span class="nx">version</span><span class="o">:</span> <span class="s1">&#39;16.x&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="nx">name</span>: <span class="kt">Compute</span> <span class="nx">cache</span> <span class="nx">key</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span>: <span class="kt">cache</span><span class="o">-</span><span class="nx">key</span>
</span></span><span class="line"><span class="cl">        <span class="nx">run</span>: <span class="kt">echo</span> <span class="s2">&#34;key=${{ runner.os }}-node-test-${{ hashFiles(&#39;package-lock.json&#39;) }}&#34;</span> <span class="o">&gt;&gt;</span> <span class="nx">$GITHUB_OUTPUT</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="nx">name</span>: <span class="kt">Cache</span> <span class="nx">node</span> <span class="kr">module</span><span class="nx">s</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span>: <span class="kt">cache</span><span class="o">-</span><span class="kr">module</span><span class="nx">s</span>
</span></span><span class="line"><span class="cl">        <span class="nx">uses</span>: <span class="kt">actions</span><span class="o">/</span><span class="nx">cache</span><span class="kd">@v3</span>
</span></span><span class="line"><span class="cl">        <span class="kd">with</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="nx">path</span><span class="o">:</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">            <span class="nx">node_modules</span>
</span></span><span class="line"><span class="cl">          <span class="nx">key</span>: <span class="kt">$</span><span class="p">{{</span> <span class="nx">steps</span><span class="p">.</span><span class="nx">cache</span><span class="o">-</span><span class="nx">key</span><span class="p">.</span><span class="nx">outputs</span><span class="p">.</span><span class="nx">key</span> <span class="p">}}</span>
</span></span><span class="line"><span class="cl">          <span class="nx">restore</span><span class="o">-</span><span class="nx">keys</span><span class="o">:</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">            <span class="nx">$</span><span class="p">{{</span> <span class="nx">runner</span><span class="p">.</span><span class="nx">os</span> <span class="p">}}</span><span class="o">-</span><span class="nx">node</span><span class="o">-</span><span class="nx">test</span><span class="o">-</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span> <span class="nx">name</span>: <span class="kt">Install</span> <span class="nx">packages</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">:</span> <span class="nx">steps</span><span class="p">.</span><span class="nx">cache</span><span class="o">-</span><span class="kr">module</span><span class="nx">s.outputs.cache</span><span class="o">-</span><span class="nx">hit</span> <span class="o">!=</span> <span class="s1">&#39;true&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">run</span>: <span class="kt">npm</span> <span class="nx">install</span>
</span></span><span class="line"><span class="cl">    <span class="nx">outputs</span>:
</span></span><span class="line"><span class="cl">      <span class="kt">cache</span><span class="o">-</span><span class="nx">key</span>: <span class="kt">$</span><span class="p">{{</span> <span class="nx">steps</span><span class="p">.</span><span class="nx">cache</span><span class="o">-</span><span class="nx">key</span><span class="p">.</span><span class="nx">outputs</span><span class="p">.</span><span class="nx">key</span> <span class="p">}}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">test</span><span class="o">-</span><span class="nx">jest</span>:
</span></span><span class="line"><span class="cl">	  <span class="kt">runs</span><span class="o">-</span><span class="nx">on</span>: <span class="kt">ubuntu</span><span class="o">-</span><span class="nx">latest</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">needs</span>: <span class="kt">prepare</span><span class="o">-</span><span class="nx">cache</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">strategy</span>:
</span></span><span class="line"><span class="cl">	    <span class="kt">fail</span><span class="o">-</span><span class="nx">fast</span>: <span class="kt">false</span>
</span></span><span class="line"><span class="cl">	    <span class="nx">matrix</span>:
</span></span><span class="line"><span class="cl">	      <span class="kt">shard</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">steps</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	    <span class="o">-</span> <span class="nx">name</span>: <span class="kt">Checkout</span>
</span></span><span class="line"><span class="cl">	      <span class="nx">uses</span>: <span class="kt">actions</span><span class="o">/</span><span class="nx">checkout</span><span class="kd">@v3</span>
</span></span><span class="line"><span class="cl">		  <span class="o">-</span> <span class="nx">name</span>: <span class="kt">Setup</span> <span class="nx">Node</span><span class="p">.</span><span class="nx">js</span>
</span></span><span class="line"><span class="cl">	      <span class="nx">uses</span>: <span class="kt">actions</span><span class="o">/</span><span class="nx">setup</span><span class="o">-</span><span class="nx">node</span><span class="kd">@v3</span>
</span></span><span class="line"><span class="cl">	      <span class="kd">with</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	        <span class="nx">node</span><span class="o">-</span><span class="nx">version</span><span class="o">:</span> <span class="s1">&#39;16.x&#39;</span>
</span></span><span class="line"><span class="cl">	    <span class="o">-</span> <span class="nx">name</span>: <span class="kt">Cache</span> <span class="nx">node</span> <span class="kr">module</span><span class="nx">s</span>
</span></span><span class="line"><span class="cl">	      <span class="nx">id</span>: <span class="kt">cache</span><span class="o">-</span><span class="kr">module</span><span class="nx">s</span>
</span></span><span class="line"><span class="cl">	      <span class="nx">uses</span>: <span class="kt">actions</span><span class="o">/</span><span class="nx">cache</span><span class="o">/</span><span class="nx">restore</span><span class="kd">@v3</span>
</span></span><span class="line"><span class="cl">	      <span class="kd">with</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	        <span class="nx">path</span><span class="o">:</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">	          <span class="nx">node_modules</span>
</span></span><span class="line"><span class="cl">	        <span class="nx">key</span>: <span class="kt">$</span><span class="p">{{</span> <span class="nx">needs</span><span class="p">.</span><span class="nx">prepare</span><span class="o">-</span><span class="nx">cache</span><span class="p">.</span><span class="nx">outputs</span><span class="p">.</span><span class="nx">cache</span><span class="o">-</span><span class="nx">key</span> <span class="p">}}</span>
</span></span><span class="line"><span class="cl">	    <span class="o">-</span> <span class="nx">name</span>: <span class="kt">Run</span> <span class="nx">tests</span>
</span></span><span class="line"><span class="cl">	      <span class="nx">run</span>: <span class="kt">npm</span> <span class="nx">test</span> <span class="o">--</span> <span class="o">-</span><span class="nx">w</span> <span class="mi">2</span> <span class="o">--</span><span class="nx">shard</span><span class="o">=</span><span class="nx">$</span><span class="p">{{</span> <span class="nx">matrix</span><span class="p">.</span><span class="nx">shard</span> <span class="p">}}</span><span class="o">/</span><span class="nx">$</span><span class="p">{{</span> <span class="nx">strategy</span><span class="p">.</span><span class="nx">job</span><span class="o">-</span><span class="nx">total</span> <span class="p">}}</span>
</span></span></code></pre></div><p>이렇게 matrix를 사용하면 30분 가까이 걸리던 CI 테스트를 5분 안에 마칠 수 있게 됩니다.</p>
<p>비용 이슈를 고민해봤을 때도, 8대를 3분씩 돌리는 것과 1대를 24분씩 돌리는 것의 비용 차이가 없기 때문에, 이렇게 쪼개서 진행해도 문제가 없다고 생각했습니다.</p>
<h2 id="코드-커버리지">코드 커버리지</h2>
<p>마지막으로, 테스트 프레임워크들은 보통 코드 커버리지 기능을 지원합니다. 이를 사용하면 테스트 코드가 구체적으로 소스 코드의 어떤 부분을 실행했는지를 측정해줍니다.</p>
<p><img src="/img/content/2023-08-04-4/2.png" alt="2.png"></p>
<p>위 예시에서는 <code>resolveString</code>의 위쪽 부분은 202회 실행되었지만, 아래쪽 부분은 실행이 되지 않아서 빨간색으로 표시된 것을 볼 수 있습니다. 이런 식으로, 소스 코드에서 if문이나, 함수 실행 등을 자세히 추적해서 어느 부분의 테스트가 누락되었는지 구체적으로 볼 수 있도록 해줍니다.</p>
<p>jest도 커버리지를 지원하기 때문에, <code>npm test -- --coverage</code> 를 통해서 바로 코드 커버리지를 생성할 수 있고, <code>lcov-report</code> 의 <code>index.html</code> 을 보고 구체적으로 코드에서 누락된 부분을 분석할 수 있습니다.</p>
<p>GitHub Actions을 사용한다면, <a href="https://github.com/ArtiomTr/jest-coverage-report-action">jest-coverage-report-action</a>을 사용하면 PR을 올렸을 때 댓글로 커버리지를 자동으로 남겨주도록 구성할 수도 있습니다.</p>
<p><img src="/img/content/2023-08-04-4/3.jpg" alt="3.jpg"></p>
<p>하지만 위처럼 샤딩을 사용하는 경우에는 설정이 복잡합니다. 샤딩에서 사용하고자 하신다면 다음 코멘트를 참고해주세요. (<a href="https://github.com/ArtiomTr/jest-coverage-report-action/issues/286#issuecomment-1427038607">#</a>)</p>
<h2 id="마치며">마치며</h2>
<p>설정할 내용이 많아서 꽤 길었지만, 이렇게 해서 jest 환경을 구성하고, 스토리북 테스트를 돌릴 수 있도록 구성했습니다. 또한 GitHub Actions으로 jest를 실행할 수 있도록 구성했고, 샤딩을 통해 분산 처리가 가능하도록 했습니다. 이를 통해 프로젝트에서 테스트를 작성하고, 필요할 때마다 실행해서 프로젝트가 잘 동작하는지 자동으로 확인할 수 있습니다.</p>
<p>이렇게 해서, 테스트 작성에 대해서 전반적인 내용을 다뤄봤습니다.</p>
<ul>
<li>테스트를 하는 이유, 테스트의 방향성과 전략</li>
<li>테스트 설계 방법과, 테스트 작성 방법</li>
<li>테스트 자동화 환경 구성하기</li>
</ul>
<p>이 글들을 통해서 테스트에 대해서 고민해보는 기회가 되었으면 좋겠고, 테스트를 통해서 제품의 품질을 높이고, 디버깅이나 테스트하는데 드는 시간을 아껴볼 수 있으셨으면 좋겠습니다.</p>
<p>감사합니다.</p>
      
    </div>

    <div class='col-lg-3 sidemenu'>
  <h4>Recent Posts</h4>
  <ul class="sidemenu-recent-list">
    
    <a href='/ko/2024-08-09-1-ui-testing-automation/'>
      <li class="sidemenu-recent-item">UI 테스트 자동화</li>
    </a>
    
    <a href='/ko/2024-08-04-1-improve-server-driven-ui/'>
      <li class="sidemenu-recent-item">Server Driven UI 호출 구조 개선</li>
    </a>
    
    <a href='/ko/2024-06-28-1-optimize-font-traffic/'>
      <li class="sidemenu-recent-item">웹폰트 최적화를 통한 CDN 비용절감</li>
    </a>
    
    <a href='/ko/2023-11-02-1-null-pointer-exception/'>
      <li class="sidemenu-recent-item">내가 만든 non-null 변수에서 NullPointerException이 발생할 리가 없어!</li>
    </a>
    
  </ul>
  <hr>
  <h4>Tags</h4>
  <ul class="sidemenu-recent-list">
    
    <a href="/ko/tags/amazon-sqs/">
      <li class="sidemenu-recent-tags">amazon-sqs</li>
    </a>
    
    <a href="/ko/tags/analytics/">
      <li class="sidemenu-recent-tags">analytics</li>
    </a>
    
    <a href="/ko/tags/android/">
      <li class="sidemenu-recent-tags">android</li>
    </a>
    
    <a href="/ko/tags/aws/">
      <li class="sidemenu-recent-tags">aws</li>
    </a>
    
    <a href="/ko/tags/aws-batch/">
      <li class="sidemenu-recent-tags">aws-batch</li>
    </a>
    
    <a href="/ko/tags/aws-lambda/">
      <li class="sidemenu-recent-tags">aws-lambda</li>
    </a>
    
    <a href="/ko/tags/botkit/">
      <li class="sidemenu-recent-tags">botkit</li>
    </a>
    
    <a href="/ko/tags/croquis/">
      <li class="sidemenu-recent-tags">croquis</li>
    </a>
    
    <a href="/ko/tags/css/">
      <li class="sidemenu-recent-tags">css</li>
    </a>
    
    <a href="/ko/tags/data/">
      <li class="sidemenu-recent-tags">data</li>
    </a>
    
    <a href="/ko/tags/event/">
      <li class="sidemenu-recent-tags">event</li>
    </a>
    
    <a href="/ko/tags/front-end/">
      <li class="sidemenu-recent-tags">front-end</li>
    </a>
    
    <a href="/ko/tags/frontend/">
      <li class="sidemenu-recent-tags">frontend</li>
    </a>
    
    <a href="/ko/tags/git/">
      <li class="sidemenu-recent-tags">git</li>
    </a>
    
    <a href="/ko/tags/github/">
      <li class="sidemenu-recent-tags">github</li>
    </a>
    
    <a href="/ko/tags/graphql/">
      <li class="sidemenu-recent-tags">graphql</li>
    </a>
    
    <a href="/ko/tags/ios/">
      <li class="sidemenu-recent-tags">ios</li>
    </a>
    
    <a href="/ko/tags/jenkins/">
      <li class="sidemenu-recent-tags">jenkins</li>
    </a>
    
    <a href="/ko/tags/jotai/">
      <li class="sidemenu-recent-tags">jotai</li>
    </a>
    
    <a href="/ko/tags/kubernetes/">
      <li class="sidemenu-recent-tags">kubernetes</li>
    </a>
    
    <a href="/ko/tags/log/">
      <li class="sidemenu-recent-tags">log</li>
    </a>
    
    <a href="/ko/tags/microservice/">
      <li class="sidemenu-recent-tags">microservice</li>
    </a>
    
    <a href="/ko/tags/mithril/">
      <li class="sidemenu-recent-tags">mithril</li>
    </a>
    
    <a href="/ko/tags/node.js/">
      <li class="sidemenu-recent-tags">node.js</li>
    </a>
    
    <a href="/ko/tags/nodejs/">
      <li class="sidemenu-recent-tags">nodejs</li>
    </a>
    
    <a href="/ko/tags/npm/">
      <li class="sidemenu-recent-tags">npm</li>
    </a>
    
    <a href="/ko/tags/react/">
      <li class="sidemenu-recent-tags">react</li>
    </a>
    
    <a href="/ko/tags/rest-api/">
      <li class="sidemenu-recent-tags">rest-api</li>
    </a>
    
    <a href="/ko/tags/serverless-architecture/">
      <li class="sidemenu-recent-tags">serverless-architecture</li>
    </a>
    
    <a href="/ko/tags/slack/">
      <li class="sidemenu-recent-tags">slack</li>
    </a>
    
    <a href="/ko/tags/stack/">
      <li class="sidemenu-recent-tags">stack</li>
    </a>
    
    <a href="/ko/tags/storybook/">
      <li class="sidemenu-recent-tags">storybook</li>
    </a>
    
    <a href="/ko/tags/task-queue/">
      <li class="sidemenu-recent-tags">task-queue</li>
    </a>
    
    <a href="/ko/tags/testing/">
      <li class="sidemenu-recent-tags">testing</li>
    </a>
    
    <a href="/ko/tags/thrift/">
      <li class="sidemenu-recent-tags">thrift</li>
    </a>
    
    <a href="/ko/tags/tutorial/">
      <li class="sidemenu-recent-tags">tutorial</li>
    </a>
    
    <a href="/ko/tags/typescript/">
      <li class="sidemenu-recent-tags">typescript</li>
    </a>
    
    <a href="/ko/tags/ui/">
      <li class="sidemenu-recent-tags">ui</li>
    </a>
    
    <a href="/ko/tags/vertical-align/">
      <li class="sidemenu-recent-tags">vertical-align</li>
    </a>
    
    <a href="/ko/tags/webpack/">
      <li class="sidemenu-recent-tags">webpack</li>
    </a>
    
    <a href="/ko/tags/%EB%A1%9C%EA%B7%B8/">
      <li class="sidemenu-recent-tags">로그</li>
    </a>
    
    <a href="/ko/tags/%EB%A7%88%EC%9D%B4%ED%81%AC%EB%A1%9C%EC%84%9C%EB%B9%84%EC%8A%A4/">
      <li class="sidemenu-recent-tags">마이크로서비스</li>
    </a>
    
    <a href="/ko/tags/%ED%8A%9C%ED%86%A0%EB%A6%AC%EC%96%BC/">
      <li class="sidemenu-recent-tags">튜토리얼</li>
    </a>
    
  </ul>
</div>

    <div class='col-12'>
      <hr>

      <div class='float-left'>
        
        <a class='btn btn-outline-primary' href='/ko/2023-08-04-3-frontend-testing-3-implement/' title='프론트엔드 테스트 자동화 전략 - 3. 구현하기'>&larr; 이전 글</a>
        
      </div>
      <div class='float-right'>
        
        <a class='btn btn-outline-primary' href='/ko/2023-11-02-1-null-pointer-exception/' title='내가 만든 non-null 변수에서 NullPointerException이 발생할 리가 없어!'>다음 글 &rarr;</a>
        
      </div>
      <div class='clearfix'></div>
      <hr>
      <div class='text-center'>
        <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "croquiscom-devblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
  </div>

</div>

<div class='container'>
  <hr>
  <footer>
    <p>
      &copy; 2012-2021 kakaostyle.com
      <span class='float-right text-muted'>
        powered by
        <a href='https://gohugo.io/' target='_blank'>Hugo</a>
        and
        <a href='https://getbootstrap.com/' target='_blank'>Bootstrap</a>
      </span>
    </p>
  </footer>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-48716672-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
  integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
  integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"
  integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
<script src="https://use.fontawesome.com/releases/v5.0.13/js/all.js"
  integrity="sha384-xymdQtn1n3lH2wcu0qhcdaOpQwyoarkgLVxC/wZ5q7h9gHtxICrpcaSUfygqZGOe" crossorigin="anonymous"></script>

</body>

</html>
